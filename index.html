<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sihirli Sesli Masal Kitabƒ± v7.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --prens-bg: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --prenses-bg: linear-gradient(135deg, #ff9a9e, #fad0c4, #ffd1ff);
        }
        body { transition: all 0.5s ease; background: #0f0c29; color: #fff; font-family: 'Montserrat', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        .card { background: rgba(26, 26, 46, 0.98); padding: 25px; border-radius: 25px; width: 85%; max-width: 400px; margin-top: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.1); }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; font-size: 16px; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-prens { background: #3498db; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); }
        .btn-prenses { background: #ff85a2; box-shadow: 0 4px 15px rgba(255, 133, 162, 0.4); }
        .btn-start { background: #f1c40f; color: #000; font-size: 18px; }
        .btn-voice { background: #9b59b6; width: auto; padding: 10px 20px; font-size: 13px; margin-bottom: 10px; border: 2px solid #fff; }
        .btn-speak { background: #e74c3c; width: 150px; padding: 10px; margin: 10px auto; font-size: 14px; display: block; }

        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: 2px solid #333; font-size: 16px; text-align: center; box-sizing: border-box; }
        .wait-msg { color: #f1c40f; font-weight: bold; margin-top: 20px; display: none; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; }
        
        .story-page { position: relative; width: 340px; height: 520px; margin: 20px auto; border: 6px solid #fff; border-radius: 15px; overflow: hidden; background: #000; }
        .page-img { width: 100%; height: 100%; object-fit: cover; }
        .page-text { position: absolute; bottom: 0; left: 0; right: 0; padding: 40px 15px 15px; color: #fff; font-size: 14px; font-weight: 700; line-height: 1.5; text-align: center; text-shadow: 2px 2px 4px #000; background: linear-gradient(transparent, rgba(0,0,0,0.95) 100%); }
    </style>
</head>
<body>

    <div class="card" id="mainCard">
        <div id="step0" class="step active">
            <h2>Ho≈ü Geldiniz ‚ú®</h2>
            <p>Masalƒ±n sesli √∂zelliklerini kullanabilmek i√ßin l√ºtfen a≈üaƒüƒ±daki butona basarak izin verin.</p>
            <button class="btn-start" onclick="requestPermissions()">Sƒ∞HRƒ∞ BA≈ûLAT ‚ú®</button>
        </div>

        <div id="step1" class="step">
            <h2>Kimin ƒ∞√ßin?</h2>
            <button class="btn-prens" onclick="initApp('Prens')">PRENSƒ∞M ƒ∞√áƒ∞N üëë</button>
            <button class="btn-prenses" onclick="initApp('Prenses')">PRENSESƒ∞M ƒ∞√áƒ∞N üéÄ</button>
        </div>

        <div id="step2" class="step">
            <h3 id="wordTitle">1. Kelime</h3>
            <p style="font-size:12px; color:#aaa;">(Mikrofonu kullanmak i√ßin butona basƒ±n)</p>
            <input type="text" id="wordInput" placeholder="Kelimeyi s√∂yleyin...">
            <button id="micBtn" class="btn-voice" onclick="startVoiceRecognition()">üéôÔ∏è SESLE S√ñYLE</button>
            <div style="display:flex; gap:10px;">
                <button class="btn-prens" style="background:#555" onclick="moveWord(-1)">‚¨Ö</button>
                <button id="nextBtn" class="btn-prens" onclick="moveWord(1)">Sƒ±radaki ‚û°</button>
            </div>
        </div>

        <div id="step3" class="step">
            <h2>Hazƒ±rƒ±z!</h2>
            <button id="finalBtn" class="btn-prens" style="background:#2ecc71" onclick="startMagic()">MASALI OLU≈ûTUR ü™Ñ</button>
            <p id="statusMsg" class="wait-msg"></p>
        </div>
    </div>

    <div id="resultArea" style="display:none; width: 100%; text-align: center;">
        <div id="storyContent"></div>
        <button onclick="location.reload()" style="background: #555; width: 200px; margin: 20px;">BA≈ûTAN BA≈ûLA</button>
    </div>

    <script>
        const API_KEY = "AIzaSyCxWkBC4p2AJzDx4PlSoY2XrGLlhFrOJkk";
        let config = { gender: '', words: [], current: 0, total: 5 };

        // 1. ƒ∞zinleri ƒ∞ste
        async function requestPermissions() {
            try {
                // Mikrofon izni iste
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // ƒ∞zni aldƒ±k, ≈üimdilik kapatalƒ±m

                // Ses motorunu uyandƒ±r
                if ('speechSynthesis' in window) {
                    const u = new SpeechSynthesisUtterance("Sihir ba≈ülƒ±yor");
                    u.volume = 0; // Sessizce uyandƒ±r
                    window.speechSynthesis.speak(u);
                }
                
                showStep(1);
            } catch (err) {
                alert("Sesli √∂zellikler i√ßin mikrofon izni gereklidir. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan izin verin.");
                showStep(1); // ƒ∞zin verilmese de devam et (manuel yazƒ±m i√ßin)
            }
        }

        function showStep(idx) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + idx).classList.add('active');
        }

        function initApp(g) {
            config.gender = g;
            document.body.className = (g === 'Prens') ? 'theme-prens' : 'theme-prenses';
            showStep(2);
        }

        function startVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor.");
            
            const r = new SpeechRecognition();
            r.lang = 'tr-TR';
            const micBtn = document.getElementById('micBtn');
            
            r.onstart = () => { micBtn.innerText = "üî¥ Dƒ∞NLENƒ∞YOR..."; micBtn.style.background = "red"; };
            r.onend = () => { micBtn.innerText = "üéôÔ∏è SESLE S√ñYLE"; micBtn.style.background = "#9b59b6"; };
            
            r.onresult = (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById('wordInput').value = text;
            };
            r.start();
        }

        function moveWord(dir) {
            const val = document.getElementById('wordInput').value.trim();
            if (dir === 1 && !val) return alert("Kelime girin.");
            
            config.words[config.current] = val;
            config.current += dir;
            
            if (config.current < 0) { config.current = 0; showStep(1); }
            else if (config.current >= config.total) showStep(3);
            else {
                document.getElementById('wordTitle').innerText = `${config.current + 1}. Kelime`;
                document.getElementById('wordInput').value = config.words[config.current] || "";
            }
        }

        function speakPage(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'tr-TR';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        async function startMagic() {
            const status = document.getElementById('statusMsg');
            status.style.display = "block";
            document.getElementById('finalBtn').disabled = true;

            try {
                status.innerText = "Masal yazƒ±lƒ±yor... ‚ú®";
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `${config.gender} i√ßin ≈üu kelimelerle 5 sayfalƒ±k masal yaz. Sayfa aralarƒ±na [SAYFA] koy: ${config.words.join(", ")}` }] }] })
                });

                const data = await res.json();
                const pages = data.candidates[0].content.parts[0].text.split('[SAYFA]').slice(0, 5);
                const container = document.getElementById('storyContent');

                for (let i = 0; i < pages.length; i++) {
                    status.innerText = `Sayfa ${i+1} hazƒ±rlanƒ±yor (15sn)... üé®`;
                    await new Promise(r => setTimeout(r, 15000));
                    
                    const pTxt = pages[i].replace(/\*/g, '').trim();
                    const seed = Math.floor(Math.random()*9999);
                    const imgUrl = `https://image.pollinations.ai/prompt/fairytale_style_${encodeURIComponent(pTxt.substring(0,50))}_${config.gender}?width=700&height=1000&seed=${seed}`;

                    container.innerHTML += `
                        <div class="story-page">
                            <img src="${imgUrl}" class="page-img">
                            <div class="page-text">
                                ${pTxt}
                                <button class="btn-speak" onclick="speakPage(\`${pTxt.replace(/[`'"]/g, '')}\`)">üîä Dƒ∞NLE</button>
                            </div>
                        </div>`;
                }
                document.getElementById('mainCard').style.display = "none";
                document.getElementById('resultArea').style.display = "block";
            } catch (e) { status.innerText = "Hata olu≈ütu, tekrar deneyin."; }
        }
    </script>
</body>
</html>
             
